<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comments</title>
</head>

<script
        src="http://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>


<script>

    async function getCommentList()
    {
        try
        {
            let response = await $.get('list');
            // $('#comment').html(JSON.stringify(response));
            $('#comment').html('')
            for(let i = 0; i < response.length; i++)
            {
                let comment = response[i];
                $('#comment').append(
                    `<div style = "display : flex; border-bottom : 1px solid silver" id = "line${comment.id}">
                        <div style = "width : 150px">${comment.userName}</div>
                        <div style = "width : 350px">${comment.content}</div>
                        <div>
                            <button onclick="updateComment(this, ${comment.id})">수정</button>
                            <button onclick="deleteComment(this, ${comment.id}, $(this).parent().parent())">삭제</button>
                        </div>
                     </div>`);
            }
        }
        catch(err)
        {
            $('#comment').html(JSON.stringify(err));
        }
    }

    async function addComment() {
        try
        {
            let newContent = {
                userId : 1,
                content : $('#text').val()
            };
            let response = await $.ajax({
                type : "post",
                url : "/add",
                contentType : 'application/json',
                data : JSON.stringify(newContent)
            });
            getCommentList();
        }
        catch(err)
        {
            console.log(JSON.stringify(err));
        }
    }

    async function deleteComment(button, id, parent) {
        if($(button).html() == "삭제")
        {
            try
            {
                let response = await $.ajax({
                    type : "delete",
                    url : "/delete/" + id
                });
                if(response === true)
                {
                    // parent.remove();
                    $(`#line${id}`).remove();
                }
                else
                {
                    alert("삭제하지 못했습니다.")
                }
            }
            catch(err)
            {
                console.log(JSON.stringify(err));
            }
        }
        else
        {
            $(button).html("삭제");
            $(button).prev().html("수정");
            $(`#line${id}`).find('div:nth-child(2)').html(content);
        }

    }

    let content = null;
    async function updateComment(button, id) {

        if($(button).html() == "수정")
        {
            let line = $(`#line${id}`);
            content = line.find('div:nth-child(2)').html();
            let input = `<input value="${content}">`;
            line.find('div:nth-child(2)').html(input);
            $(button).html('확인');
            $(button).next().html("취소");
        }
        else
        {
            try
            {
                let line = $(`#line${id}`);
                content = line.find('div:nth-child(2)').find('input').val();
                let newContent = {
                    id : id,
                    content : content
                };
                await $.ajax({
                    type : "put",
                    url : "/update/",
                    contentType : 'application/json',
                    data : JSON.stringify(newContent)
                });

                $(button).html("수정");
                $(button).next().html("삭제");

                line.find('div:nth-child(2)').html(content);
                // getCommentList();
            }
            catch(e)
            {

            }

        }
    }
    
    async function uploadFile(fileinput) {
        try
        {
            //파일 선택 안 했을 때 작동하는 코드 추가 바람
            let file = fileinput[0].files[0];
            if(file == null)
                return;
            let formData = new FormData();
            formData.append("uploadFile", file);
            let response = await $.ajax({
                type : "post",
                url : "/attachment",
                data : formData,
                processData : false,
                contentType : false
            });
            return response;
        }
        catch(err)
        {
            console.log(JSON.stringify(err));
        }
    }

    async function getUserList() {
        try
        {
            let user = $("#user");
            response = await $.ajax({
                url : "listuser",
                type : "get",

            });
            user.html("");
            for(let i = 0; i < response.length; i++)
            {
                let userName = response[i].userName;
                let email = response[i].email;
                let imagePath = response[i].imagePath;
                let id = response[i].id;
                if(imagePath == null)
                {
                    imagePath = "사진 없음";
                }
                user.append(`<div id = "userLine${response[i].id}" style = "display : flex; border-bottom : 1px solid silver">
                                <div style = "width : 150px">${userName}</div>
                                <div style = "width : 350px">${email}</div>
                                <div style = "width : 150px">${imagePath}</div>
                                <div>
                                    <button onclick="updateUserPic(this, ${id})">프사 수정</button>
                                    <button onclick="deleteUser(this, ${id})">삭제</button>
                                </div>
                            </div>`);
            }
        }
        catch(err)
        {
            console.log(JSON.stringify(err));
        }
    }
    
    async function addUser() {
        try
        {
            let userName = $("#userName").val();
            let email = $("#email").val();
            let newUser = {
                userName : userName,
                email : email
            };

            response = await $.ajax({
                url : "/adduser",
                type : "post",
                contentType : 'application/json',
                data : JSON.stringify(newUser)
            });
            getUserList();
        }
        catch (err) {
            console.log(JSON.stringify(err));
        }
    }

    async function deleteUser(button, id) {
        if($(button).html() == "삭제")
        {
            try
            {
                response = await $.ajax({
                    url : "/deleteuser/" + id,
                    type : "delete"
                });
                // if(response)
                // {
                //     let line = $(`#userLine${id}`);
                //     line.remove();
                // }
                getUserList();
            }
            catch (err) {
                console.log(JSON.stringify(err));
            }
        }
        else
        {
            let line = $(`#userLine${id}`);
            line.find("div:nth-child(3)").html(userPic);
            $(button).html("삭제");
            $(button).prev().html("프사 수정");
        }
    }

    let userPic = null;
    async function updateUserPic(button, id) {
        let line = $(`#userLine${id}`);

        if($(button).html() == "프사 수정")
        {

            let pic = line.find("div:nth-child(3)");
            userPic = pic.html();
            pic.html(`<input type="file" id="upload-file" multiple>`);
            $(button).html("확인");
            $(button).next().html("취소");
        }
        else
        {
            let file = line.find("div:nth-child(3)").find("input");
            response = await uploadFile(file);
            if(response == null)
            {
                alert("사진이 선택되지 않았습니다.");
                return;
            }
            try
            {
                let userName = line.find("div:nth-child(1)").html();
                let email = line.find("div:nth-child(2)").html();
                let picture = response;

                let newUser = {
                    userName : userName,
                    email : email,
                    imagePath : picture
                }

                response = await $.ajax({
                    type : "put",
                    url : "updateuser/" + id,
                    contentType : "application/json",
                    data : JSON.stringify(newUser)
                });

                getUserList();
            }
            catch (err) {
                console.log(JSON.stringify(err));
            }
        }
    }
</script>
<body>
    <div>
        <input id = "text" style = "width : 400px">
        <button onclick="addComment()">확인</button>
    </div>
    <p id = "comment"></p><br>
    <button id = "btn" onclick="getCommentList()">코멘트 목록 받기</button>
    <div>
        유저 이름<input id = "userName">
        이메일<input id = "email">
        <button onclick="addUser()">유저 추가</button><br>
        <button onclick="getUserList()">유저 목록 받기</button>
    </div>
    <p id = "user"></p>
</body>
</html>